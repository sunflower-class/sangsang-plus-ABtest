import json
import uuid
from datetime import datetime
from typing import Dict, List, Any, Optional
from dataclasses import dataclass, asdict

@dataclass
class PageTemplate:
    """ÌéòÏù¥ÏßÄ ÌÖúÌîåÎ¶ø Ï†ïÎ≥¥"""
    template_id: str
    name: str
    layout_type: str
    color_scheme: str
    font_style: str
    cta_position: str
    features: List[str]
    css_styles: Dict[str, str]
    html_structure: str

class PageGenerator:
    """ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÉùÏÑ±Í∏∞"""
    
    def __init__(self):
        self.templates = self._initialize_templates()
    
    def _initialize_templates(self) -> Dict[str, PageTemplate]:
        """Í∏∞Î≥∏ ÌÖúÌîåÎ¶ø Ï¥àÍ∏∞Ìôî"""
        templates = {}
        
        # ÌÖúÌîåÎ¶ø A: ÌûàÏñ¥Î°ú Ïä§ÌÉÄÏùº (ÌòÑÎåÄÏ†Å)
        templates["hero_modern"] = PageTemplate(
            template_id="hero_modern",
            name="ÌûàÏñ¥Î°ú Î™®Îçò",
            layout_type="hero",
            color_scheme="light",
            font_style="modern",
            cta_position="floating",
            features=["Î¶¨Î∑∞", "Î∞∞ÏÜ°Ï†ïÎ≥¥", "Ïä§Ìéô"],
            css_styles={
                "primary_color": "#2563eb",
                "secondary_color": "#f8fafc",
                "text_color": "#1e293b",
                "cta_color": "#dc2626",
                "font_family": "'Inter', sans-serif"
            },
            html_structure="hero_modern"
        )
        
        # ÌÖúÌîåÎ¶ø B: Í∑∏Î¶¨Îìú Ïä§ÌÉÄÏùº (ÌÅ¥ÎûòÏãù)
        templates["grid_classic"] = PageTemplate(
            template_id="grid_classic",
            name="Í∑∏Î¶¨Îìú ÌÅ¥ÎûòÏãù",
            layout_type="grid",
            color_scheme="neutral",
            font_style="classic",
            cta_position="bottom",
            features=["Î¶¨Î∑∞", "Q&A", "Í¥ÄÎ†®ÏÉÅÌíà"],
            css_styles={
                "primary_color": "#374151",
                "secondary_color": "#f9fafb",
                "text_color": "#111827",
                "cta_color": "#059669",
                "font_family": "'Georgia', serif"
            },
            html_structure="grid_classic"
        )
        
        # ÌÖúÌîåÎ¶ø C: Ïπ¥Îìú Ïä§ÌÉÄÏùº (ÎØ∏ÎãàÎ©Ä)
        templates["card_minimal"] = PageTemplate(
            template_id="card_minimal",
            name="Ïπ¥Îìú ÎØ∏ÎãàÎ©Ä",
            layout_type="card",
            color_scheme="minimal",
            font_style="elegant",
            cta_position="middle",
            features=["Ïä§Ìéô", "Î∞∞ÏÜ°Ï†ïÎ≥¥"],
            css_styles={
                "primary_color": "#000000",
                "secondary_color": "#ffffff",
                "text_color": "#374151",
                "cta_color": "#000000",
                "font_family": "'Helvetica Neue', sans-serif"
            },
            html_structure="card_minimal"
        )
        
        # ÌÖúÌîåÎ¶ø D: Í∞§Îü¨Î¶¨ Ïä§ÌÉÄÏùº (Ïª¨Îü¨ÌíÄ)
        templates["gallery_colorful"] = PageTemplate(
            template_id="gallery_colorful",
            name="Í∞§Îü¨Î¶¨ Ïª¨Îü¨ÌíÄ",
            layout_type="gallery",
            color_scheme="colorful",
            font_style="bold",
            cta_position="top",
            features=["Î¶¨Î∑∞", "Q&A", "Í¥ÄÎ†®ÏÉÅÌíà", "Ïä§Ìéô"],
            css_styles={
                "primary_color": "#7c3aed",
                "secondary_color": "#fef3c7",
                "text_color": "#1f2937",
                "cta_color": "#f59e0b",
                "font_family": "'Poppins', sans-serif"
            },
            html_structure="gallery_colorful"
        )
        
        return templates
    
    def generate_page_variants(self, product_info: Dict[str, Any], variant_count: int = 4) -> List[Dict[str, Any]]:
        """ÏÉÅÌíà Ï†ïÎ≥¥Î•º Î∞îÌÉïÏúºÎ°ú Îã§ÏñëÌïú ÌéòÏù¥ÏßÄ Î≥ÄÌòï ÏÉùÏÑ±"""
        variants = []
        template_keys = list(self.templates.keys())
        
        # CTA ÌÖçÏä§Ìä∏ ÏòµÏÖò
        cta_options = [
            "ÏßÄÍ∏à Íµ¨Îß§ÌïòÍ∏∞",
            "Ïû•Î∞îÍµ¨Îãà Îã¥Í∏∞",
            "Ï¶âÏãú Íµ¨Îß§",
            "ÏûêÏÑ∏Ìûà Î≥¥Í∏∞",
            "Ìï†Ïù∏ Î∞õÍ∏∞",
            "ÌäπÍ∞Ä Íµ¨Îß§"
        ]
        
        # Ïù¥ÎØ∏ÏßÄ Ïä§ÌÉÄÏùº ÏòµÏÖò
        image_styles = ["original", "enhanced", "minimal", "gallery"]
        
        for i in range(min(variant_count, len(template_keys))):
            template = self.templates[template_keys[i]]
            
            # Î≥ÄÌòïÎ≥Ñ ÌäπÏÑ± ÏÑ§Ï†ï
            variant = {
                "variant_id": str(uuid.uuid4()),
                "variant_type": chr(65 + i),  # A, B, C, D
                "title": self._generate_title(product_info, template),
                "description": self._generate_description(product_info, template),
                "layout_type": template.layout_type,
                "color_scheme": template.color_scheme,
                "cta_text": cta_options[i % len(cta_options)],
                "cta_color": template.css_styles["cta_color"],
                "cta_position": template.cta_position,
                "additional_features": template.features,
                "image_style": image_styles[i % len(image_styles)],
                "font_style": template.font_style,
                "created_at": datetime.now().isoformat(),
                "is_active": True,
                "template": asdict(template)
            }
            
            variants.append(variant)
        
        return variants
    
    def _generate_title(self, product_info: Dict[str, Any], template: PageTemplate) -> str:
        """ÌÖúÌîåÎ¶øÏóê ÎßûÎäî Ï†úÎ™© ÏÉùÏÑ±"""
        product_name = product_info.get("product_name", "")
        category = product_info.get("category", "")
        price = product_info.get("price", 0)
        
        if template.font_style == "modern":
            return f"‚ú® {product_name} - ÏµúÏã† Ìä∏Î†åÎìú"
        elif template.font_style == "classic":
            return f"{product_name} | {category}"
        elif template.font_style == "elegant":
            return f"{product_name}"
        elif template.font_style == "bold":
            return f"üî• {product_name} ÌäπÍ∞Ä!"
        
        return product_name
    
    def _generate_description(self, product_info: Dict[str, Any], template: PageTemplate) -> str:
        """ÌÖúÌîåÎ¶øÏóê ÎßûÎäî ÏÑ§Î™Ö ÏÉùÏÑ±"""
        description = product_info.get("product_description", "")
        price = product_info.get("price", 0)
        category = product_info.get("category", "")
        
        if template.layout_type == "hero":
            return f"{description}\n\nüíé ÌîÑÎ¶¨ÎØ∏ÏóÑ {category} Ï†úÌíàÏùÑ ÌäπÎ≥ÑÌïú Í∞ÄÍ≤©ÏúºÎ°ú ÎßåÎÇòÎ≥¥ÏÑ∏Ïöî!"
        elif template.layout_type == "grid":
            return f"{description}\n\nüì¶ ÏïàÏ†ÑÌïú Î∞∞ÏÜ°Í≥º Ìï®Íªò ÎßåÏ°±ÎèÑ ÎÜíÏùÄ {category}Î•º Í≤ΩÌóòÌïòÏÑ∏Ïöî."
        elif template.layout_type == "card":
            return f"{description}"
        elif template.layout_type == "gallery":
            return f"{description}\n\nüéØ Í≥†Í∞ùÎì§Ïù¥ ÏÑ†ÌÉùÌïú Ïù∏Í∏∞ {category} Ï†úÌíàÏûÖÎãàÎã§!"
        
        return description
    
    def generate_html_page(self, variant: Dict[str, Any], product_info: Dict[str, Any]) -> str:
        """HTML ÌéòÏù¥ÏßÄ ÏÉùÏÑ±"""
        template = variant["template"]
        
        html = f"""
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{variant['title']}</title>
    <style>
        {self._generate_css(template, variant)}
    </style>
</head>
<body>
    {self._generate_html_structure(template['html_structure'], variant, product_info)}
    
    <script>
        {self._generate_javascript(variant)}
    </script>
</body>
</html>
        """
        
        return html
    
    def _generate_css(self, template: Dict[str, Any], variant: Dict[str, Any]) -> str:
        """CSS Ïä§ÌÉÄÏùº ÏÉùÏÑ±"""
        styles = template["css_styles"]
        
        css = f"""
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}
        
        body {{
            font-family: {styles['font_family']};
            background-color: {styles['secondary_color']};
            color: {styles['text_color']};
            line-height: 1.6;
        }}
        
        .container {{
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }}
        
        .product-header {{
            text-align: center;
            margin-bottom: 40px;
        }}
        
        .product-title {{
            font-size: 2.5rem;
            font-weight: bold;
            color: {styles['primary_color']};
            margin-bottom: 10px;
        }}
        
        .product-description {{
            font-size: 1.2rem;
            color: {styles['text_color']};
            margin-bottom: 20px;
        }}
        
        .product-image {{
            width: 100%;
            max-width: 600px;
            height: auto;
            border-radius: 10px;
            margin: 20px 0;
        }}
        
        .product-price {{
            font-size: 2rem;
            font-weight: bold;
            color: {styles['primary_color']};
            margin: 20px 0;
        }}
        
        .cta-button {{
            background-color: {styles['cta_color']};
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }}
        
        .cta-button:hover {{
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }}
        
        .features-section {{
            margin: 40px 0;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }}
        
        .feature-item {{
            margin: 10px 0;
            padding: 10px;
            background-color: {styles['secondary_color']};
            border-radius: 5px;
        }}
        
        .floating-cta {{
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }}
        """
        
        return css
    
    def _generate_html_structure(self, structure_type: str, variant: Dict[str, Any], product_info: Dict[str, Any]) -> str:
        """HTML Íµ¨Ï°∞ ÏÉùÏÑ±"""
        if structure_type == "hero_modern":
            return self._generate_hero_structure(variant, product_info)
        elif structure_type == "grid_classic":
            return self._generate_grid_structure(variant, product_info)
        elif structure_type == "card_minimal":
            return self._generate_card_structure(variant, product_info)
        elif structure_type == "gallery_colorful":
            return self._generate_gallery_structure(variant, product_info)
        
        return self._generate_hero_structure(variant, product_info)
    
    def _generate_hero_structure(self, variant: Dict[str, Any], product_info: Dict[str, Any]) -> str:
        """ÌûàÏñ¥Î°ú Ïä§ÌÉÄÏùº Íµ¨Ï°∞"""
        return f"""
        <div class="container">
            <div class="product-header">
                <h1 class="product-title">{variant['title']}</h1>
                <p class="product-description">{variant['description']}</p>
            </div>
            
            <div style="text-align: center;">
                <img src="{product_info['product_image']}" alt="{product_info['product_name']}" class="product-image">
                <div class="product-price">‚Ç©{product_info['price']:,}</div>
                <button class="cta-button" onclick="handlePurchase()">{variant['cta_text']}</button>
            </div>
            
            <div class="features-section">
                <h3>Ï†úÌíà ÌäπÏßï</h3>
                {self._generate_features_html(variant['additional_features'])}
            </div>
        </div>
        
        {self._generate_floating_cta(variant) if variant['cta_position'] == 'floating' else ''}
        """
    
    def _generate_grid_structure(self, variant: Dict[str, Any], product_info: Dict[str, Any]) -> str:
        """Í∑∏Î¶¨Îìú Ïä§ÌÉÄÏùº Íµ¨Ï°∞"""
        return f"""
        <div class="container">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; align-items: center;">
                <div>
                    <h1 class="product-title">{variant['title']}</h1>
                    <p class="product-description">{variant['description']}</p>
                    <div class="product-price">‚Ç©{product_info['price']:,}</div>
                    <button class="cta-button" onclick="handlePurchase()">{variant['cta_text']}</button>
                </div>
                <div>
                    <img src="{product_info['product_image']}" alt="{product_info['product_name']}" class="product-image">
                </div>
            </div>
            
            <div class="features-section">
                <h3>Ï†úÌíà Ï†ïÎ≥¥</h3>
                {self._generate_features_html(variant['additional_features'])}
            </div>
        </div>
        """
    
    def _generate_card_structure(self, variant: Dict[str, Any], product_info: Dict[str, Any]) -> str:
        """Ïπ¥Îìú Ïä§ÌÉÄÏùº Íµ¨Ï°∞"""
        return f"""
        <div class="container">
            <div style="max-width: 800px; margin: 0 auto;">
                <div style="background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h1 class="product-title">{variant['title']}</h1>
                    <img src="{product_info['product_image']}" alt="{product_info['product_name']}" class="product-image">
                    <p class="product-description">{variant['description']}</p>
                    <div class="product-price">‚Ç©{product_info['price']:,}</div>
                    <button class="cta-button" onclick="handlePurchase()">{variant['cta_text']}</button>
                    
                    <div class="features-section">
                        <h3>ÏÉÅÏÑ∏ Ï†ïÎ≥¥</h3>
                        {self._generate_features_html(variant['additional_features'])}
                    </div>
                </div>
            </div>
        </div>
        """
    
    def _generate_gallery_structure(self, variant: Dict[str, Any], product_info: Dict[str, Any]) -> str:
        """Í∞§Îü¨Î¶¨ Ïä§ÌÉÄÏùº Íµ¨Ï°∞"""
        return f"""
        <div class="container">
            <div class="product-header">
                <h1 class="product-title">{variant['title']}</h1>
                <p class="product-description">{variant['description']}</p>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div>
                    <img src="{product_info['product_image']}" alt="{product_info['product_name']}" class="product-image">
                </div>
                <div>
                    <div class="product-price">‚Ç©{product_info['price']:,}</div>
                    <button class="cta-button" onclick="handlePurchase()">{variant['cta_text']}</button>
                </div>
            </div>
            
            <div class="features-section">
                <h3>Ï†úÌíà ÌäπÏßï</h3>
                {self._generate_features_html(variant['additional_features'])}
            </div>
        </div>
        """
    
    def _generate_features_html(self, features: List[str]) -> str:
        """ÌäπÏßï Î™©Î°ù HTML ÏÉùÏÑ±"""
        feature_icons = {
            "Î¶¨Î∑∞": "‚≠ê",
            "Î∞∞ÏÜ°Ï†ïÎ≥¥": "üöö",
            "Ïä§Ìéô": "üìã",
            "Q&A": "‚ùì",
            "Í¥ÄÎ†®ÏÉÅÌíà": "üõçÔ∏è"
        }
        
        html = ""
        for feature in features:
            icon = feature_icons.get(feature, "üìå")
            html += f'<div class="feature-item">{icon} {feature}</div>'
        
        return html
    
    def _generate_floating_cta(self, variant: Dict[str, Any]) -> str:
        """ÌîåÎ°úÌåÖ CTA Î≤ÑÌäº"""
        return f"""
        <div class="floating-cta">
            <button class="cta-button" onclick="handlePurchase()">{variant['cta_text']}</button>
        </div>
        """
    
    def _generate_javascript(self, variant: Dict[str, Any]) -> str:
        """JavaScript ÏΩîÎìú ÏÉùÏÑ±"""
        return f"""
        function handlePurchase() {{
            // A/B ÌÖåÏä§Ìä∏ Ïù¥Î≤§Ìä∏ Ï∂îÏ†Å
            trackEvent('click', '{variant['variant_id']}');
            
            // Íµ¨Îß§ Ï≤òÎ¶¨ Î°úÏßÅ
            alert('Íµ¨Îß§Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!');
        }}
        
        function trackEvent(eventType, variantId) {{
            // Ïù¥Î≤§Ìä∏ Ï∂îÏ†Å API Ìò∏Ï∂ú
            fetch('/api/abtest/event', {{
                method: 'POST',
                headers: {{
                    'Content-Type': 'application/json',
                }},
                body: JSON.stringify({{
                    test_id: getTestId(),
                    variant_id: variantId,
                    event_type: eventType,
                    user_id: getUserId(),
                    session_id: getSessionId()
                }})
            }});
        }}
        
        function getTestId() {{
            // URL ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú ÌÖåÏä§Ìä∏ ID Ï∂îÏ∂ú
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('test_id') || '';
        }}
        
        function getUserId() {{
            // ÏÇ¨Ïö©Ïûê ID Î∞òÌôò (Ïã§Ï†ú Íµ¨ÌòÑÏóêÏÑúÎäî ÏÑ∏ÏÖò/Ïø†ÌÇ§ÏóêÏÑú Ï∂îÏ∂ú)
            return localStorage.getItem('user_id') || 'anonymous';
        }}
        
        function getSessionId() {{
            // ÏÑ∏ÏÖò ID Î∞òÌôò
            return sessionStorage.getItem('session_id') || Date.now().toString();
        }}
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÎÖ∏Ï∂ú Ïù¥Î≤§Ìä∏ Ï∂îÏ†Å
        window.addEventListener('load', function() {{
            trackEvent('impression', '{variant['variant_id']}');
        }});
        """

# Ï†ÑÏó≠ Ïù∏Ïä§ÌÑ¥Ïä§
page_generator = PageGenerator()


